@model IEnumerable<UXComex.GerenciadorPedidos.Domain.Entities.Product>

@{
    ViewData["Title"] = "Products";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Product List</h2>
        <a asp-action="Create" class="btn btn-primary">Create New Product</a>
    </div>

    <div class="input-group mb-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by name" />
        <button class="btn btn-outline-secondary" type="button" id="searchButton">Search</button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover rounded shadow-sm">
            <thead class="thead-dark">
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Stock Quantity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <!-- Table rows will be populated dynamically by jQuery -->
            </tbody>
        </table>
    </div>

    <!-- Pagination controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination" id="pagination-container">
        </ul>
    </nav>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteProductModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this product? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Html.AntiForgeryToken()

    <script>
        $(document).ready(function () {
            let currentPage = 1;
            let pageSize = 10;
            let currentSearchTerm = '';
            let productIdToDelete = null;

            function loadProducts(page, searchTerm) {
                // Show a loading indicator
                $('#productsTableBody').html('<tr><td colspan="5" class="text-center">Loading...</td></tr>');

                $.get('@Url.Action("GetProducts", "Product")', {
                    searchTerm: searchTerm,
                    pageNumber: page,
                    pageSize: pageSize
                }, function (data) {
                    const products = data.items;
                    const totalPages = data.totalPages;

                    // Clear existing rows
                    $('#productsTableBody').empty();

                    if (products.length === 0) {
                        $('#productsTableBody').html('<tr><td colspan="5" class="text-center">No products found.</td></tr>');
                    } else {
                        // Populate the table with new data
                        $.each(products, function (index, product) {
                            const row = `<tr>
                                <td>${product.name}</td>
                                <td>${product.description || ''}</td>
                                <td>${product.price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                <td>${product.stockQuantity}</td>
                                <td>
                                    <a href="/Product/Edit/${product.id}" class="btn btn-sm btn-info">Edit</a>
                                    <button class="btn btn-sm btn-danger delete-btn" data-bs-toggle="modal" data-bs-target="#deleteProductModal" data-product-id="${product.id}">Delete</button>
                                </td>
                            </tr>`;
                            $('#productsTableBody').append(row);
                        });
                    }

                    // Rebuild pagination links
                    const paginationContainer = $('#pagination-container');
                    paginationContainer.empty();

                    for (let i = 1; i <= totalPages; i++) {
                        const activeClass = i === page ? 'active' : '';
                        const li = `<li class="page-item ${activeClass}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                        paginationContainer.append(li);
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    $('#productsTableBody').html('<tr><td colspan="5" class="text-center text-danger">Failed to load products.</td></tr>');
                    console.error("Error fetching products:", errorThrown);
                });
            }

            // Initial load of products
            // TODO: change the currentSearchTerm to be a ViewData attribute,
            // so if the user searches and then navigates away and comes back,
            // the search term is preserved.
            loadProducts(currentPage, currentSearchTerm);

            $('#searchButton').on('click', function () {
                currentSearchTerm = $('#searchInput').val();
                currentPage = 1;
                loadProducts(currentPage, currentSearchTerm);
            });

            // Handle enter key press in search input
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#searchButton').click();
                }
            });

            $('#pagination-container').on('click', '.page-link', function (e) {
                e.preventDefault();
                const newPage = $(this).data('page');
                if (newPage !== currentPage) {
                    currentPage = newPage;
                    loadProducts(currentPage, currentSearchTerm);
                }
            });

            // Open the delete modal
            $('#productsTableBody').on('click', '.delete-btn', function() {
                productIdToDelete = $(this).data('product-id');
            });

            // Event handler for the confirm delete button inside the modal
            $('#confirmDeleteButton').on('click', function () {
                if (productIdToDelete) {
                    // Get the anti-forgery token from the hidden input field
                    const antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

                    $.ajax({
                        url: `@Url.Action("Delete", "Product", new { id = "__id__" })`.replace('__id__', productIdToDelete),
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': antiForgeryToken
                        },
                        success: function (result) {
                            // Close the modal and reload the client list on success
                            var modal = bootstrap.Modal.getInstance(document.getElementById('deleteProductModal'));
                            modal.hide();
                            loadProducts(currentPage, currentSearchTerm);
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.error("Error deleting product:", errorThrown);
                            alert("Failed to delete product. Please try again.");
                        }
                    });
                }
            });
        });
    </script>
}
